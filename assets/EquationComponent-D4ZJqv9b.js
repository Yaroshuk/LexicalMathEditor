import{o as j,r as f,u as O,j as A,A as F,n as h,w as M,c as H,N,C as q,a as L,v as R,b as U,P as V,d as z,e as m,f as W,$}from"./index-C5HKeWm6.js";import"//unpkg.com/mathlive";const Y="_MathField_1tgyv_1",B="_Focused_1tgyv_9",y={MathField:Y,Focused:B};function S(a){var n,i,r="";if(typeof a=="string"||typeof a=="number")r+=a;else if(typeof a=="object")if(Array.isArray(a))for(n=0;n<a.length;n++)a[n]&&(i=S(a[n]))&&(r&&(r+=" "),r+=i);else for(n in a)a[n]&&(r&&(r+=" "),r+=n);return r}function G(){for(var a,n,i=0,r="";i<arguments.length;)(a=arguments[i++])&&(n=S(a))&&(r&&(r+=" "),r+=n);return r}const _=W();function Q({equation:a,nodeKey:n,initialFocus:i}){const[r]=j(),[v]=f.useState(!1),[P,w]=f.useState(null),[C,x,E]=O(n),d=f.useRef(null),b=f.useCallback(e=>A(e.registerCommand(_,t=>{if((t==null?void 0:t.nodeKey)!==n)return!1;const o=d.current;return o?(e.blur(),o.focus(),t.cursorPosition==="end"&&o.executeCommand("moveToMathfieldEnd"),t.cursorPosition==="start"&&o.executeCommand("moveToMathfieldStart"),!0):!1},F)),[n]);f.useEffect(()=>{i&&r.update(()=>{const e=h(n);if(e){const t=e.getWritable();t.__initialFocus=!1}})},[i,r,n]),f.useEffect(()=>{if(d.current===null)return;const e=d.current;e.value=a},[a]);const k=f.useCallback((e,t)=>{var u;if(!((u=e.target.dataset)!=null&&u.lexicalEditor))return!1;const s=M();if(!H(s)||s.isCollapsed()===!1)return!1;const c=s.anchor.getNode();if(e.key==="ArrowLeft"){let l=null;if(N(c)){if(s.anchor.offset===0)return!1;l=c.getChildAtIndex(s.anchor.offset-1)}else s.anchor.offset===0&&(l=c.getPreviousSibling());if(!l)return!1;if(l&&l.__type==="equation")return t.dispatchCommand(_,{nodeKey:l.__key,cursorPosition:"end"}),e.preventDefault(),!0}if(e.key==="ArrowRight"){let l=null;if(N(c)){if(console.log("111",s.anchor.offset,c.getChildrenSize()),s.anchor.offset===c.getChildrenSize())return!1;l=c.getChildAtIndex(s.anchor.offset),console.log("node",l)}else s.anchor.offset===c.getTextContent().length&&(l=c.getNextSibling());if(!l)return!1;if(l&&l.__type==="equation")return t.dispatchCommand(_,{nodeKey:l.__key,cursorPosition:"start"}),e.preventDefault(),!0}return!1},[]),g=f.useCallback((e,t="after")=>{if(!e)return;const o=e.getParent();if(!o)return;const s=o.getChildren().indexOf(e),c=q();t==="after"?(c.anchor.set(o.__key,s+1,"element"),c.focus.set(o.__key,s+1,"element")):(c.anchor.set(o.__key,s,"element"),c.focus.set(o.__key,s,"element")),L(c),r.focus()},[r]),p=f.useCallback(e=>{const t=e.target,o=t.selection,s=t.value,c=t.dataset.key;if(!c)return!1;const u=h(c);if(!u)return!1;if(e.key==="ArrowLeft")return o.ranges[0][0]===0&&o.ranges[0][1]===0?(t.blur(),g(u,"before"),!0):!1;if(e.key==="ArrowRight"){const l=t.getValue(0,o.ranges[0][1]);return s.length===l.length?(t.blur(),g(u,"after"),!0):!1}return!1},[g]);f.useEffect(()=>A(r.registerUpdateListener(({editorState:e})=>{w(e.read(()=>M()))}),r.registerCommand(U,e=>{const t=e;return t.target===d.current?(t.shiftKey||E(),x(!C),!0):!1},V),r.registerCommand(R,e=>{const t=e.target;return console.log("KEY_DOWN_COMMAND"),t.tagName==="MATH-FIELD"?p(e,r):k(e,r)},F)),[E,r,C,n,k,p,x,v]),f.useEffect(()=>{b(r)},[r,b]);const T=z(P)&&C,D=e=>{r.update(()=>{const t=h(n);console.log("changeHandler",t,e),$(t)&&t.setEquation(e)})},I=()=>{r.update(()=>{const e=h(n);e&&g(e,"after")})};return m.jsx(m.Fragment,{children:m.jsx("span",{className:G(y.MathField,T&&y.Focused),children:m.jsx("math-field",{onInput:e=>D(e.target.value),"data-key":n,ref:e=>{if(e===null)return;const t=e;t.value=a,i&&(t==null||t.focus(),a.includes("placeholder{}")?t==null||t.executeCommand("moveToNextPlaceholder"):t==null||t.executeCommand("moveToMathfieldEnd")),t.onchange=o=>{const s=o.target;return console.log("onchange",s,s.value),s.blur(),setTimeout(()=>{I()},0),o.stopPropagation(),!1},d.current=e},tabIndex:-1})})})}export{_ as FOCUS_CUSTOM_INPUT_COMMAND,Q as default};
